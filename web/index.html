<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StackIQ — Live Quote</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 2rem;
      color: #111827;
    }
    header {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #111827;
    }
    header span {
      color: #2563eb;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
    }
    .card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .quote-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .quote-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .pill {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-radius: 9999px;
    }
    .price {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }
    .label {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .val {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .status-line {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #6b7280;
    }
    .segmented {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .segmented button {
      flex: 1;
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      font-weight: 500;
    }
    .segmented button.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>Stack<span>IQ</span></header>
  <div class="layout">
    <!-- Left: Quote + Chart -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <input id="symInp" placeholder="AAPL" value="AAPL" 
                 style="padding:0.4rem 0.8rem;border:1px solid #d1d5db;border-radius:0.5rem;" />
          <button id="go" 
                  style="margin-left:0.5rem;padding:0.5rem 1rem;border:none;border-radius:0.5rem;background:#2563eb;color:white;cursor:pointer;">
            Get Quote
          </button>
        </div>
        <div class="quote-header" style="margin-top:1rem;">
          <h2 id="sym">—</h2>
          <span id="chgPill" class="pill" style="display:none;"></span>
        </div>
        <div class="price" id="px">—</div>
        <div class="grid">
          <div><div class="label">Session High</div><div class="val" id="hi">—</div></div>
          <div><div class="label">Session Low</div><div class="val" id="lo">—</div></div>
          <div><div class="label">Open</div><div class="val" id="op">—</div></div>
          <div><div class="label">Prev Close</div><div class="val" id="pc">—</div></div>
        </div>
        <div id="blurb" style="margin-top:1rem;font-size:0.9rem;color:#374151;">—</div>
        <div class="segmented">
          <button data-range="1mo" class="active">1M</button>
          <button data-range="3mo">3M</button>
          <button data-range="6mo">6M</button>
          <button data-range="1y">1Y</button>
        </div>
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>

    <!-- Right: Status -->
    <div>
      <div class="card">
        <h3>Status</h3>
        <div id="statusLine">Idle.</div>
        <div style="margin-top:1rem;font-size:0.85rem;">
          Health: <span id="health">—</span><br/>
          Version: <span id="ver">—</span>
        </div>
      </div>
    </div>
  </div>
  <footer>© 2025 StackIQ • minimal market data UI</footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const symInp = $("symInp");
    let chart;

    function segBtns() {
      return Array.from(document.querySelectorAll(".segmented button"));
    }

    function ensureChart(ctx) {
      if (chart) return chart;
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Price",
            data: [],
            borderColor: "#2563eb",
            backgroundColor: "rgba(37,99,235,0.1)",
            fill: true,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: true, ticks: { maxTicksLimit: 6 } },
            y: { display: true, beginAtZero: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: "index", intersect: false }
          }
        }
      });
      return chart;
    }

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${url} -> ${r.status}`);
      return r.json();
    }

    function setStatus(msg) {
      $("statusLine").textContent = msg;
    }

    async function loadMeta() {
      try {
        const [h, v] = await Promise.all([
          fetch("/health").then(r => r.status),
          fetchJSON("/version")
        ]);
        $("health").textContent = h;
        $("ver").textContent = `${v.app} v${v.version}`;
      } catch (e) {
        $("health").textContent = "error";
        $("ver").textContent = "—";
      }
    }

    function renderQuote(payload) {
      const q = payload.quote;
      $("sym").textContent = payload.symbol;
      $("px").textContent  = (q.current ?? "—");
      $("hi").textContent  = (q.high ?? "—");
      $("lo").textContent  = (q.low ?? "—");
      $("op").textContent  = (q.open ?? "—");
      $("pc").textContent  = (q.prev_close ?? "—");
      $("blurb").textContent = payload.summary;

      // change pill
      const pill = $("chgPill");
      const pc = Number(q.percent_change ?? 0);
      if (!Number.isNaN(pc)) {
        pill.style.display = "";
        pill.textContent = `${pc >= 0 ? "▲" : "▼"} ${Math.abs(pc).toFixed(2)}%`;
        pill.style.background = pc >= 0 ? "#eafff1" : "#ffecec";
        pill.style.color = pc >= 0 ? "#16a34a" : "#b91c1c";
      } else {
        pill.style.display = "none";
      }
    }

    async function loadQuoteAndSummary(symbol) {
      setStatus("Loading…");
      try {
        const payload = await fetchJSON(`/summary/${encodeURIComponent(symbol)}`);
        renderQuote(payload);
        setStatus("Loaded.");
      } catch (e) {
        setStatus(`Quote error: ${e.message}`);
      }
    }

    function renderHistory(points) {
      const ctx = $("chart").getContext("2d");
      const c = ensureChart(ctx);

      const labels = points.map(p => new Date(p.t));
      const data = points.map(p => p.c);

      c.data.labels = labels;
      c.data.datasets[0].data = data;
      c.update();
    }

    async function loadHistory(symbol, range) {
      try {
        const h = await fetchJSON(`/history/${encodeURIComponent(symbol)}?range=${range}`);
        renderHistory(h.points);
      } catch (e) {
        setStatus(`History error: ${e.message}`);
      }
    }

    function activeRange() {
      const active = segBtns().find(b => b.classList.contains("active"));
      return active ? active.dataset.range : "1y";
    }

    async function run(symbol) {
      await loadQuoteAndSummary(symbol);
      await loadHistory(symbol, activeRange());
    }

    // UI wiring
    $("go").addEventListener("click", () => run(symInp.value.trim() || "AAPL"));
    symInp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") $("go").click();
    });
    segBtns().forEach(btn => {
      btn.addEventListener("click", () => {
        segBtns().forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        run(symInp.value.trim() || "AAPL");
      });
    });

    // boot
    loadMeta();
    run(symInp.value.trim() || "AAPL");
  </script>
</body>
</html>







