<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StackIQ – Live Stocks</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a22;
      --muted: #8a90a2;
      --text: #e6e9ef;
      --accent: #4da3ff;
      --ok: #3ddc84;
      --danger: #ff6b6b;
      --card: #1b1f2a;
      --border: #232838;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, #131722 0%, #0f1115 45%);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .wrap {
      max-width: 1100px;
      margin: 36px auto;
      padding: 0 16px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .title {
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 28px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #111520;
      color: var(--muted);
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 0 4px #111520 inset;
    }
    .dot.ok { background: var(--ok); }

    .grid {
      display: grid;
      grid-template-columns: 460px 1fr;
      gap: 24px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 40%) , var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.25);
    }
    h2 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.6px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .row { display: flex; gap: 8px; }
    .input {
      flex: 1 1 auto;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1420;
      color: var(--text);
      padding: 0 12px;
      outline: none;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(77,163,255,0.35);
      background: radial-gradient(120% 120% at 0% 0%, rgba(77,163,255,0.25), rgba(77,163,255,0.05)) , #102033;
      color: #cfe6ff;
      font-weight: 700;
      height: 40px;
      padding: 0 14px;
      border-radius: 10px;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .hint { margin-top: 8px; color: var(--muted); font-size: 12px; }
    .error { color: var(--danger); font-weight: 700; margin-top: 8px; min-height: 18px; }

    .stack { display: grid; gap: 12px; }
    .select, .range, .input {
      width: 100%;
      background: #0f1420;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    .subtle { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .rec {
      margin-top: 10px;
      font-weight: 800;
      letter-spacing: 0.5px;
      color: #b8c7ff;
      min-height: 20px;
    }

    .kv {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 6px;
    }
    .kv .cell {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      min-height: 58px;
    }
    .k { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .v { font-size: 16px; font-weight: 700; }

    .earnings {
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      max-height: 260px;
      overflow: auto;
    }
    .earn-item { padding: 8px 0; border-bottom: 1px dashed var(--border); }
    .earn-item:last-child { border-bottom: 0; }
    .earn-item strong { color: #d5d9ff; }

    footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
    a { color: #9ecaff; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">StackIQ</div>
      <div class="pill"><span id="apiDot" class="dot"></span> <span id="apiText">API status</span></div>
    </header>

    <div class="grid">
      <!-- Left: Controls -->
      <div class="card">
        <h2>Enter Stock Ticker</h2>
        <div class="row">
          <input id="tickerInput" class="input" placeholder="AAPL, MSFT, NVDA…" />
          <button id="fetchBtn" class="btn">Fetch</button>
        </div>
        <div class="hint">Tip: you can also open <code>/test/AAPL?pretty=1</code> directly.</div>
        <div id="err" class="error"></div>

        <h2 style="margin-top:18px;">Strategy Wizard</h2>
        <div class="stack">
          <div>
            <div class="subtle">Investment Horizon</div>
            <select id="horizon" class="select">
              <option value="short">Short (weeks)</option>
              <option value="medium" selected>Medium (months)</option>
              <option value="long">Long (years)</option>
            </select>
          </div>
          <div>
            <div class="subtle">Risk Tolerance</div>
            <select id="risk" class="select">
              <option>Low</option>
              <option selected>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div>
            <div class="subtle">Conviction (0–10)</div>
            <input id="conviction" type="number" min="0" max="10" step="1" value="5" class="input" />
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button id="recBtn" class="btn">Get Recommendation</button>
          </div>
          <div id="rec" class="rec">Recommendation: —</div>
        </div>
      </div>

      <!-- Right: Quote / Earnings -->
      <div class="card">
        <h2>Quote</h2>
        <div class="kv">
          <div class="cell"><div class="k">Current Price</div><div class="v" id="currentPrice">—</div></div>
          <div class="cell"><div class="k">Change</div><div class="v" id="change">—</div></div>
          <div class="cell"><div class="k">% Change</div><div class="v" id="percentChange">—</div></div>
          <div class="cell"><div class="k">Open</div><div class="v" id="open">—</div></div>
          <div class="cell"><div class="k">High</div><div class="v" id="high">—</div></div>
          <div class="cell"><div class="k">Low</div><div class="v" id="low">—</div></div>
          <div class="cell"><div class="k">Prev Close</div><div class="v" id="prevClose">—</div></div>
          <div class="cell"><div class="k">Volume</div><div class="v" id="volume">—</div></div>
        </div>

        <h2 style="margin-top:16px;">Earnings</h2>
        <div id="earnings" class="earnings">No recent earnings in feed.</div>
      </div>
    </div>

    <footer>
      UI runs from <code>/web</code>. Data served by <code>/test/:symbol</code>, <code>/quote/:symbol</code>, <code>/earnings/:symbol</code>. Health: <code>/health</code>.
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // --- API status poll ---
    async function pollHealth() {
      try {
        const r = await fetch('/health');
        const ok = r.ok && (await r.json()).ok === true;
        $('apiDot').classList.toggle('ok', ok);
        $('apiText').textContent = ok ? 'API is live' : 'API unreachable';
      } catch {
        $('apiDot').classList.remove('ok');
        $('apiText').textContent = 'API unreachable';
      }
    }
    pollHealth();
    setInterval(pollHealth, 15000);

    // --- Format helpers ---
    const nf2 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
    const nfi = new Intl.NumberFormat();

    function setQuote(q) {
      $('currentPrice').textContent  = q?.current != null ? nf2.format(q.current) : '—';
      $('change').textContent        = q?.change  != null ? nf2.format(q.change) : '—';
      $('percentChange').textContent = q?.percent_change != null ? nf2.format(q.percent_change) + '%' : '—';
      $('open').textContent          = q?.open    != null ? nf2.format(q.open) : '—';
      $('high').textContent          = q?.high    != null ? nf2.format(q.high) : '—';
      $('low').textContent           = q?.low     != null ? nf2.format(q.low) : '—';
      $('prevClose').textContent     = q?.prev_close != null ? nf2.format(q.prev_close) : '—';
      $('volume').textContent        = q?.volume  != null ? nfi.format(q.volume) : '—';
    }

    function setEarnings(earn) {
      const box = $('earnings');
      if (!earn?.items?.length) {
        box.textContent = 'No recent earnings in feed.';
        return;
      }
      box.innerHTML = earn.items.map(it => `
        <div class="earn-item">
          <strong>${it.period}</strong> — EPS Actual: <strong>${nf2.format(it.epsActual ?? it.actual ?? 0)}</strong>,
          Estimate: ${nf2.format(it.epsEstimate ?? it.estimate ?? 0)}
          ${it.surprise != null ? `, Surprise: ${nf2.format(it.surprise)}` : ''}
        </div>
      `).join('');
    }

    // --- Fetch flow ---
    async function fetchStock() {
      $('err').textContent = '';
      const symbol = $('tickerInput').value.trim().toUpperCase();
      if (!symbol) { $('err').textContent = 'Enter a ticker (e.g., AAPL).'; return; }

      $('fetchBtn').disabled = true;
      try {
        const r = await fetch(`/test/${encodeURIComponent(symbol)}`);
        const data = await r.json();

        if (!r.ok) {
          $('err').textContent = (data && data.detail) ? data.detail : 'Fetch failed.';
          setQuote(null); setEarnings(null);
          return;
        }

        setQuote(data.quote);
        setEarnings(data.earnings);
        lastQuote = data.quote || null; // keep for recommendation
      } catch (e) {
        console.error(e);
        $('err').textContent = 'Network error.';
      } finally {
        $('fetchBtn').disabled = false;
      }
    }

    // --- Simple recommendation using quote + user inputs ---
    let lastQuote = null;
    function makeRecommendation() {
      const risk = $('risk').value.toLowerCase();
      const horizon = $('horizon').value.toLowerCase();
      const conv = Math.max(0, Math.min(10, parseInt($('conviction').value || '5', 10)));
      const pct = Number(lastQuote?.percent_change ?? 0);

      let rec = 'HOLD';
      if (pct > 0.75 && conv >= 6) rec = 'BUY';
      if (pct < -0.75 && risk === 'low') rec = 'HOLD';
      if (pct < -1.2 || (pct < -0.8 && conv <= 3)) rec = 'AVOID';

      // small horizon nudge
      if (horizon === 'long' && pct > 0 && conv >= 7) rec = 'BUY';
      if (horizon === 'short' && Math.abs(pct) < 0.3) rec = 'HOLD';

      $('rec').textContent = `Recommendation: ${rec}`;
    }

    // --- Wire up ---
    $('fetchBtn').addEventListener('click', fetchStock);
    $('recBtn').addEventListener('click', makeRecommendation);
    $('tickerInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') fetchStock();
    });
  </script>
</body>
</html>




